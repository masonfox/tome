version: '3.8'

services:
  # ⚠️ WARNING: DO NOT SCALE THIS SERVICE ⚠️
  #
  # This service runs database migrations on startup. Running multiple
  # instances simultaneously will cause race conditions and potential
  # data corruption.
  #
  # DO NOT RUN: docker-compose up --scale tome=3
  #
  # While the migration system has locking to prevent concurrent execution,
  # SQLite's file-based locking may not be reliable across all volume
  # mount types (especially network mounts like NFS).
  #
  # For high availability:
  # - Use blue-green deployment strategy
  # - Run migrations as a separate step before deployment
  # - Use a single instance with proper health checks
  #
  tome:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - CALIBRE_DB_PATH=/calibre/metadata.db
    volumes:
      # Persist SQLite database
      # NOTE: The container runs as user 'nextjs' (UID 1001)
      # On first run, the entrypoint will ensure the directory is writable
      # If you encounter permission errors, you can either:
      #   1. Let the container handle permissions (recommended)
      #   2. Or run with: docker-compose run --user 1001:1001 tome
      - tome-data:/app/data
      # Mount your Calibre library (read-write for rating sync)
      # Replace with your actual Calibre library path
      - ./calibre-library:/calibre
    restart: unless-stopped

volumes:
  tome-data:
    driver: local
    # Volume will be created with default permissions
    # The entrypoint script ensures proper permissions on first run
