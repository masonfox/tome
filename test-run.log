bun test v1.3.0 (b0a6feca)

__tests__/api/progress.test.ts:
Using bun:sqlite for Tome database
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:19.000Z,
  streakStartDate: 2025-11-20T00:27:19.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:19.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:19.000Z,
  streakStartDate: 2025-11-20T00:27:19.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:19.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
[Progress] Book completed, session status updated to 'read'
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
[Progress] Book completed, session status updated to 'read'
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
469 |     sqlite.exec(`UPDATE reading_sessions SET updated_at = ${Math.floor(oldTime.getTime() / 1000)} WHERE id = ${session!.id}`);
470 | 
471 |     // Verify the old timestamp is set
472 |     const sessionBefore = await sessionRepository.findById(session!.id);
473 |     const sessionBeforeTime = sessionBefore?.updatedAt.getTime() || 0;
474 |     expect(sessionBeforeTime).toBeLessThanOrEqual(oldTime.getTime() + 1000); // Allow small variance
                                    ^
error: expect(received).toBeLessThanOrEqual(expected)

Expected: <= 1763598381036
Received: 1763598440000

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/progress.test.ts:474:31)
(fail) Progress API - POST /api/books/[id]/progress > updates session updatedAt timestamp when logging progress [2.00ms]

__tests__/api/sessions.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/api/stats.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
111 |     });
112 | 
113 |     const response = await getOverview();
114 |     const data = await response.json();
115 | 
116 |     expect(data.booksRead.total).toBe(2);
                                       ^
error: expect(received).toBe(expected)

Expected: 2
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/stats.test.ts:116:34)
(fail) Stats API - GET /api/stats/overview > counts books read correctly [4.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
140 |     });
141 | 
142 |     const response = await getOverview();
143 |     const data = await response.json();
144 | 
145 |     expect(data.booksRead.thisMonth).toBe(1); // Only this month
                                           ^
error: expect(received).toBe(expected)

Expected: 1
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/stats.test.ts:145:38)
(fail) Stats API - GET /api/stats/overview > calculates books read this month correctly [5.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/api/status.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Archiving session #1 and creating new session for backward movement
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Rebuilding streak after session archival
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-15T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Archiving session #1 and creating new session for backward movement
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Rebuilding streak after session archival
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-15T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Archiving session #1 and creating new session for backward movement
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Rebuilding streak after session archival
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-17T00:00:00.000Z",
  streakStartDate: "2025-11-17T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Archiving session #1 and creating new session for backward movement
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Rebuilding streak after session archival
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-15T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Archiving session #2 and creating new session for backward movement
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Rebuilding streak after session archival
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-15T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Archiving session #1 and creating new session for backward movement
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Rebuilding streak after session archival
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-15T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Archiving session #1 and creating new session for backward movement
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Status] Rebuilding streak after session archival
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-15T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database

__tests__/api/books-detail.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
41 |     const request = new Request("http://localhost:3000/api/books/1");
42 |     const response = await GET(request, { params: { id: book.id.toString() } });
43 |     const data = await response.json();
44 | 
45 |     expect(response.status).toBe(200);
46 |     expect(data.totalReads).toBe(1);
                                 ^
error: expect(received).toBe(expected)

Expected: 1
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/books-detail.test.ts:46:29)
(fail) GET /api/books/[id] > should return book with totalReads count for single session [3.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
87 |     const request = new Request("http://localhost:3000/api/books/2");
88 |     const response = await GET(request, { params: { id: book.id.toString() } });
89 |     const data = await response.json();
90 | 
91 |     expect(response.status).toBe(200);
92 |     expect(data.totalReads).toBe(2); // Only completed reads count
                                 ^
error: expect(received).toBe(expected)

Expected: 2
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/books-detail.test.ts:92:29)
(fail) GET /api/books/[id] > should return book with totalReads count for multiple sessions [2.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
245 |     const request1 = new Request("http://localhost:3000/api/books/6");
246 |     const response1 = await GET(request1, { params: { id: book1.id.toString() } });
247 |     const data1 = await response1.json();
248 | 
249 |     expect(response1.status).toBe(200);
250 |     expect(data1.totalReads).toBe(1); // Only one completed read (session 2 is reading)
                                   ^
error: expect(received).toBe(expected)

Expected: 1
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/books-detail.test.ts:250:30)
(fail) GET /api/books/[id] > should count only sessions for specific book [3.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
303 |     const request = new Request("http://localhost:3000/api/books/8");
304 |     const response = await GET(request, { params: { id: book.id.toString() } });
305 |     const data = await response.json();
306 | 
307 |     expect(response.status).toBe(200);
308 |     expect(data.totalReads).toBe(2);
                                  ^
error: expect(received).toBe(expected)

Expected: 2
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/books-detail.test.ts:308:29)
(fail) GET /api/books/[id] > should include totalReads even when no active session exists [3.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/api/session-lifecycle.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/api/reread.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 1
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 1
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #2 for book 2
getTestDatabase called, returning: test database
[Reread] Created new session #3 for book 2
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 3
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 3
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
115 |     expect(data.session.startedDate).toBeDefined();
116 | 
117 |     // startedDate is returned as an ISO string (Drizzle serializes Date objects)
118 |     expect(typeof data.session.startedDate).toBe("string");
119 |     const startedDate = new Date(data.session.startedDate);
120 |     expect(startedDate.getTime()).toBeGreaterThanOrEqual(beforeTime.getTime());
                                        ^
error: expect(received).toBeGreaterThanOrEqual(expected)

Expected: >= 1763598440311
Received: 1763598440000

      at <anonymous> (/home/masonfox/git/tome/__tests__/api/reread.test.ts:120:35)
(fail) POST /api/books/[id]/reread > should set status to 'reading' and startedDate on new session [3.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 4
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 4
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 5
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 5
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 6
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 6
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-17T00:00:00.000Z",
  streakStartDate: "2025-11-17T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
[Reread] Streak rebuilt: {
  currentStreak: 1,
  longestStreak: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #5 for book 11
getTestDatabase called, returning: test database
[Reread] Created new session #6 for book 11
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 12
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 12
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 2,
  longestStreak: 2,
  totalDaysActive: 2,
  lastActivityDate: "2025-11-16T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
[Reread] Streak rebuilt: {
  currentStreak: 2,
  longestStreak: 2,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 13
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 13
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 14
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 14
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 14
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
Error starting re-read: 74 |     if (!fields && !customResultMapper) {
75 |       const params = fillPlaceholders(query.params, placeholderValues ?? {});
76 |       logger.logQuery(query.sql, params);
77 |       return stmt.all(...params);
78 |     }
79 |     const rows = this.values(placeholderValues);
                           ^
SQLiteError: UNIQUE constraint failed: reading_sessions.book_id
      errno: 2067,
 byteOffset: -1,
       code: "SQLITE_CONSTRAINT_UNIQUE"

      at all (/home/masonfox/git/tome/node_modules/drizzle-orm/bun-sqlite/session.js:79:23)
      at create (/home/masonfox/git/tome/lib/repositories/base.repository.ts:90:89)
      at create (/home/masonfox/git/tome/lib/repositories/base.repository.ts:89:16)
      at POST (/home/masonfox/git/tome/app/api/books/[id]/reread/route.ts:63:48)
      at async <anonymous> (/home/masonfox/git/tome/__tests__/api/reread.test.ts:378:50)

[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database

__tests__/api/books.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/integration/library-service-api.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/unit/edge-cases.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
67 |       return new Date(value * 1e3);
68 |     }
69 |     return new Date(value);
70 |   }
71 |   mapToDriverValue(value) {
72 |     const unix = value.getTime();
                            ^
TypeError: value.getTime is not a function. (In 'value.getTime()', 'value.getTime' is undefined)
      at mapToDriverValue (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/columns/integer.js:72:24)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:141:73)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:62:26)
      at _prepare (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/query-builders/insert.js:147:20)
(fail) Edge Case Tests > Streak Calculation > should handle streak with no activity [1.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/unit/constraints.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
67 |       return new Date(value * 1e3);
68 |     }
69 |     return new Date(value);
70 |   }
71 |   mapToDriverValue(value) {
72 |     const unix = value.getTime();
                            ^
TypeError: value.getTime is not a function. (In 'value.getTime()', 'value.getTime' is undefined)
      at mapToDriverValue (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/columns/integer.js:72:24)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:141:73)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:62:26)
      at _prepare (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/query-builders/insert.js:147:20)
(fail) Database Constraints > Streak Constraints > should enforce one streak per user (singleton pattern) [1.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/unit/aggregations.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
156 |         status: "reading",
157 |         isActive: true,
158 |       });
159 | 
160 |       const count = await sessionRepository.countByStatus("read", false);
161 |       expect(count).toBe(2);
                          ^
error: expect(received).toBe(expected)

Expected: 2
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/aggregations.test.ts:161:21)
(fail) Aggregation Query Tests > Books Read Count > should count completed sessions [3.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
193 |         isActive: false,
194 |         completedDate: new Date(),
195 |       });
196 | 
197 |       const countSinceYesterday = await sessionRepository.countCompletedAfterDate(yesterday);
198 |       expect(countSinceYesterday).toBe(1);
                                        ^
error: expect(received).toBe(expected)

Expected: 1
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/aggregations.test.ts:198:35)
(fail) Aggregation Query Tests > Books Read Count > should count books read after date [2.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
239 |         status: "reading",
240 |         isActive: false,
241 |       });
242 | 
243 |       const count = await sessionRepository.countByStatus("reading", true);
244 |       expect(count).toBe(2);
                          ^
error: expect(received).toBe(expected)

Expected: 2
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/aggregations.test.ts:244:21)
(fail) Aggregation Query Tests > Currently Reading Count > should only count active reading sessions [3.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/unit/search.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

__tests__/integration/api/read-filter-lifecycle.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Updating streak after progress log
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
[Streak] Updated: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 1
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 1
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-20T00:00:00.000Z",
  streakStartDate: "2025-11-20T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
[Reread] Streak rebuilt: {
  currentStreak: 1,
  longestStreak: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Starting re-read after completed session #1 for book 2
getTestDatabase called, returning: test database
[Reread] Created new session #2 for book 2
[Reread] Rebuilding streak...
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Reread] Streak rebuilt: {
  currentStreak: 0,
  longestStreak: 0,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
67 |       return new Date(value * 1e3);
68 |     }
69 |     return new Date(value);
70 |   }
71 |   mapToDriverValue(value) {
72 |     const unix = value.getTime();
                            ^
TypeError: value.getTime is not a function. (In 'value.getTime()', 'value.getTime' is undefined)
      at mapToDriverValue (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/columns/integer.js:72:24)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:141:73)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:62:26)
      at _prepare (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/query-builders/insert.js:147:20)
(fail) Integration: Read Filter Lifecycle > archived session without active session appears correctly [1.00ms]

__tests__/unit/lib/streaks.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
[Streak] No existing streak found, creating new one
getTestDatabase called, returning: test database
[Streak] New streak created: {
  currentStreak: 1,
  longestStreak: 1,
  lastActivityDate: 2025-11-20T00:27:20.000Z,
  streakStartDate: 2025-11-20T00:27:20.000Z,
  totalDaysActive: 1,
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
67 |       return new Date(value * 1e3);
68 |     }
69 |     return new Date(value);
70 |   }
71 |   mapToDriverValue(value) {
72 |     const unix = value.getTime();
                            ^
TypeError: value.getTime is not a function. (In 'value.getTime()', 'value.getTime' is undefined)
      at mapToDriverValue (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/columns/integer.js:72:24)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:141:73)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:62:26)
      at _prepare (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/query-builders/insert.js:147:20)
(fail) updateStreaks > initializes streak to 1 when currentStreak is 0 on same day [1.00ms]
getTestDatabase called, returning: test database
67 |       return new Date(value * 1e3);
68 |     }
69 |     return new Date(value);
70 |   }
71 |   mapToDriverValue(value) {
72 |     const unix = value.getTime();
                            ^
TypeError: value.getTime is not a function. (In 'value.getTime()', 'value.getTime' is undefined)
      at mapToDriverValue (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/columns/integer.js:72:24)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:141:73)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at map (1:11)
      at buildQueryFromSourceParams (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:83:32)
      at <anonymous> (/home/masonfox/git/tome/node_modules/drizzle-orm/sql/sql.js:62:26)
      at _prepare (/home/masonfox/git/tome/node_modules/drizzle-orm/sqlite-core/query-builders/insert.js:147:20)
(fail) updateStreaks > returns unchanged streak when activity on same day with existing streak
getTestDatabase called, returning: test database
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
83 |     return rows.map((row) => mapResultRow(fields, row, joinsNotNullableMap));
84 |   }
85 |   get(placeholderValues) {
86 |     const params = fillPlaceholders(this.query.params, placeholderValues ?? {});
87 |     this.logger.logQuery(this.query.sql, params);
88 |     const row = this.stmt.values(...params)[0];
                               ^
TypeError: Binding expected string, TypedArray, boolean, number, bigint or null
      at get (/home/masonfox/git/tome/node_modules/drizzle-orm/bun-sqlite/session.js:88:27)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:220:8)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:207:28)
      at updateStreaks (/home/masonfox/git/tome/lib/streaks.ts:34:50)
      at async <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/streaks.test.ts:97:26)
(fail) updateStreaks > initializes streak when daysDiff is 1 but currentStreak is 0 [1.00ms]
getTestDatabase called, returning: test database
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
83 |     return rows.map((row) => mapResultRow(fields, row, joinsNotNullableMap));
84 |   }
85 |   get(placeholderValues) {
86 |     const params = fillPlaceholders(this.query.params, placeholderValues ?? {});
87 |     this.logger.logQuery(this.query.sql, params);
88 |     const row = this.stmt.values(...params)[0];
                               ^
TypeError: Binding expected string, TypedArray, boolean, number, bigint or null
      at get (/home/masonfox/git/tome/node_modules/drizzle-orm/bun-sqlite/session.js:88:27)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:220:8)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:207:28)
      at updateStreaks (/home/masonfox/git/tome/lib/streaks.ts:34:50)
      at async <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/streaks.test.ts:123:26)
(fail) updateStreaks > increments streak on consecutive day activity [1.00ms]
getTestDatabase called, returning: test database
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
83 |     return rows.map((row) => mapResultRow(fields, row, joinsNotNullableMap));
84 |   }
85 |   get(placeholderValues) {
86 |     const params = fillPlaceholders(this.query.params, placeholderValues ?? {});
87 |     this.logger.logQuery(this.query.sql, params);
88 |     const row = this.stmt.values(...params)[0];
                               ^
TypeError: Binding expected string, TypedArray, boolean, number, bigint or null
      at get (/home/masonfox/git/tome/node_modules/drizzle-orm/bun-sqlite/session.js:88:27)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:220:8)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:207:28)
      at updateStreaks (/home/masonfox/git/tome/lib/streaks.ts:34:50)
      at async <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/streaks.test.ts:149:26)
(fail) updateStreaks > updates longestStreak when current exceeds it
getTestDatabase called, returning: test database
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
83 |     return rows.map((row) => mapResultRow(fields, row, joinsNotNullableMap));
84 |   }
85 |   get(placeholderValues) {
86 |     const params = fillPlaceholders(this.query.params, placeholderValues ?? {});
87 |     this.logger.logQuery(this.query.sql, params);
88 |     const row = this.stmt.values(...params)[0];
                               ^
TypeError: Binding expected string, TypedArray, boolean, number, bigint or null
      at get (/home/masonfox/git/tome/node_modules/drizzle-orm/bun-sqlite/session.js:88:27)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:220:8)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:207:28)
      at updateStreaks (/home/masonfox/git/tome/lib/streaks.ts:34:50)
      at async <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/streaks.test.ts:175:26)
(fail) updateStreaks > resets streak to 1 when gap is more than 1 day [1.00ms]
getTestDatabase called, returning: test database
[Streak] updateStreaks called with userId: null
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
83 |     return rows.map((row) => mapResultRow(fields, row, joinsNotNullableMap));
84 |   }
85 |   get(placeholderValues) {
86 |     const params = fillPlaceholders(this.query.params, placeholderValues ?? {});
87 |     this.logger.logQuery(this.query.sql, params);
88 |     const row = this.stmt.values(...params)[0];
                               ^
TypeError: Binding expected string, TypedArray, boolean, number, bigint or null
      at get (/home/masonfox/git/tome/node_modules/drizzle-orm/bun-sqlite/session.js:88:27)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:220:8)
      at getProgressForDate (/home/masonfox/git/tome/lib/repositories/progress.repository.ts:207:28)
      at updateStreaks (/home/masonfox/git/tome/lib/streaks.ts:34:50)
      at async <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/streaks.test.ts:199:26)
(fail) updateStreaks > handles totalDaysActive = 0 on broken streak [1.00ms]
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
Test database created successfully
Running migrations on test database...
Test migrations complete!
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] No progress data found, creating empty streak
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-19T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 5,
  longestStreak: 5,
  totalDaysActive: 5,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-15T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 2,
  longestStreak: 3,
  totalDaysActive: 5,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-18T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 4,
  longestStreak: 4,
  totalDaysActive: 4,
  lastActivityDate: "2025-11-14T00:00:00.000Z",
  streakStartDate: "2025-11-11T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
444 |       });
445 |     }
446 | 
447 |     const result = await rebuildStreak();
448 | 
449 |     expect(result.currentStreak).toBe(0); // Broken streak (last activity was 14th, today is 19th)
                                       ^
error: expect(received).toBe(expected)

Expected: 0
Received: 4

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/streaks.test.ts:449:34)
(fail) rebuildStreak > should reset current streak if last activity > 1 day ago [2.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 3,
  longestStreak: 3,
  totalDaysActive: 3,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-17T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 3,
  longestStreak: 3,
  totalDaysActive: 3,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-17T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-19T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 1,
  longestStreak: 1,
  totalDaysActive: 1,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-19T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 3,
  longestStreak: 5,
  totalDaysActive: 10,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-17T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 2,
  longestStreak: 2,
  totalDaysActive: 2,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-18T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Rebuilding streak from all progress data
getTestDatabase called, returning: test database
[Streak] Calculated streak stats: {
  currentStreak: 3,
  longestStreak: 3,
  totalDaysActive: 3,
  lastActivityDate: "2025-11-19T00:00:00.000Z",
  streakStartDate: "2025-11-17T00:00:00.000Z",
}
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
[Streak] Streak rebuilt and saved successfully
745 |     const result = await rebuildStreak();
746 | 
747 |     // Last activity should be the most recent day
748 |     const lastActivity = new Date(result.lastActivityDate * 1000);
749 |     const expectedLastActivity = new Date("2025-11-19T00:00:00.000Z");
750 |     expect(lastActivity.toISOString().substring(0, 10)).toBe(expectedLastActivity.toISOString().substring(0, 10));
                                                              ^
error: expect(received).toBe(expected)

Expected: "2025-11-19"
Received: "+057853-06"

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/streaks.test.ts:750:57)
(fail) rebuildStreak > should correctly set lastActivityDate and streakStartDate [2.00ms]

__tests__/unit/lib/dashboard-service.test.ts:
Test database created successfully
Running migrations on test database...
Test migrations complete!
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
49 |       );
50 | 
51 |       const result = await getDashboardData();
52 | 
53 |       // Should show 8 total, but only return 6 books in array
54 |       expect(result.currentlyReadingTotal).toBe(8);
                                                ^
error: expect(received).toBe(expected)

Expected: 8
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/dashboard-service.test.ts:54:44)
(fail) Dashboard Service > getDashboardData > should return correct total counts for currently reading books [11.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
82 |       );
83 | 
84 |       const result = await getDashboardData();
85 | 
86 |       // Should show 10 total, but only return 6 books in array
87 |       expect(result.readNextTotal).toBe(10);
                                        ^
error: expect(received).toBe(expected)

Expected: 10
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/dashboard-service.test.ts:87:36)
(fail) Dashboard Service > getDashboardData > should return correct total counts for read-next books [9.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
137 |       // Verify all books are present
138 |       const titles = result.currentlyReading.map(b => b.title).sort();
139 |       expect(titles).toEqual(["Book 1", "Book 2", "Book 3"]);
140 | 
141 |       // Verify first book is the most recently updated (Book 3)
142 |       expect(result.currentlyReading[0].title).toBe("Book 3");
                                                     ^
error: expect(received).toBe(expected)

Expected: "Book 3"
Received: "Book 1"

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/dashboard-service.test.ts:142:48)
(fail) Dashboard Service > getDashboardData > should return books sorted by most recently updated first [52.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
168 |       );
169 | 
170 |       const result = await getDashboardData();
171 | 
172 |       // Should show 3 total and return all 3 books
173 |       expect(result.currentlyReadingTotal).toBe(3);
                                                 ^
error: expect(received).toBe(expected)

Expected: 3
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/dashboard-service.test.ts:173:44)
(fail) Dashboard Service > getDashboardData > should handle case with fewer than 6 books [6.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
210 |       );
211 | 
212 |       const result = await getDashboardData();
213 | 
214 |       // Total count includes all active sessions (8 sessions)
215 |       expect(result.currentlyReadingTotal).toBe(8);
                                                 ^
error: expect(received).toBe(expected)

Expected: 8
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/dashboard-service.test.ts:215:44)
(fail) Dashboard Service > getDashboardData > should exclude orphaned books from results [10.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
281 |       });
282 | 
283 |       const result = await getDashboardData();
284 | 
285 |       // Should only count/return the active session
286 |       expect(result.currentlyReadingTotal).toBe(1);
                                                 ^
error: expect(received).toBe(expected)

Expected: 1
Received: 0

      at <anonymous> (/home/masonfox/git/tome/__tests__/unit/lib/dashboard-service.test.ts:286:44)
(fail) Dashboard Service > getDashboardData > should only return active sessions [5.00ms]
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database
getTestDatabase called, returning: test database

 266 pass
 29 fail
 814 expect() calls
Ran 295 tests across 20 files. [1106.00ms]
