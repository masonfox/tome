# Hotfix v0.4.1: Date Timezone Display Issue

**Branch**: `hotfix/v0.4.1-date-timezone-fix`
**Related Issue**: [#245](https://github.com/masonfox/tome/issues/245)
**Date**: 2026-01-08

## Issue Summary

Dates in reading progress display incorrectly (one day behind) in the Journal section on the Book Detail page for users in timezones ahead of UTC. The main Journal page displays dates correctly because it passes timezone context to the API.

**Example:** User in Tokyo (UTC+9) logs progress for Jan 8 → Shows as Jan 7 in Book Detail Journal

## Root Cause Analysis

### Architecture (per ADR-006)

**The Right Way™ Pattern**: Frontend sends local midnight as ISO timestamp, backend stores as-is, queries use timezone-aware logic.

Per ADR-006 (Dec 2, 2025 update), the system uses **user timezone stored in streaks table** for all date calculations.

### Data Flow (Correct Behavior)

1. **Storage**: User selects "Jan 8" in local timezone
   - Hook: `startOfDay(parseISO("2025-01-08"))`
   - **IMPORTANT**: `parseISO("2025-01-08")` creates midnight in LOCAL timezone (per date-fns behavior)
   - For Tokyo user (UTC+9): Creates Jan 8 00:00 JST
   - `toISOString()` converts to UTC: `"2025-01-07T15:00:00.000Z"` (midnight JST = 3pm previous day UTC)
   - Stored as Unix timestamp in SQLite
   - **Hook is working correctly! ✅**

2. **Retrieval**: API returns ISO string
   - Book Detail endpoint: `/api/books/[id]/progress` returns raw ISO strings: `"2025-01-07T15:00:00.000Z"`
   - Main Journal endpoint: `/api/journal?timezone=Asia/Tokyo` handles timezone conversion server-side ✅

3. **Display Bug in JournalEntryList** (THE ONLY PROBLEM):
   - Line 36: `entry.progressDate.split('T')[0]` extracts `"2025-01-07"` (UTC date) ❌
   - This is naive string splitting - doesn't respect timezone!
   - Should extract LOCAL calendar date from timestamp: `"2025-01-08"` ✅

   **Why this is wrong**: When you split "2025-01-07T15:00:00.000Z" on 'T', you get the UTC date "2025-01-07", but that timestamp represents Jan 8 00:00 in Tokyo timezone!

### Why Main Journal Works
- Passes `timezone` parameter to API (`/app/journal/page.tsx:76`)
- Server groups entries by local calendar day using `toZonedTime`
- Returns correct `date` field already in local timezone format (YYYY-MM-DD)
- **No client-side date parsing needed** - server does the work

### Why Book Detail Journal Fails
- Fetches from `/api/books/[id]/progress` (no timezone param)
- Returns raw ISO strings: `"2025-01-07T15:00:00.000Z"`
- **Naively splits at 'T' to extract UTC date** instead of parsing as Date and extracting local components

### Answer to Question: Is the Hook Wrong Too?

**NO - The hook is correct!** ✅

The confusion comes from how `parseISO` works:
- `parseISO("2025-01-08")` (date-only string) creates midnight in **browser's LOCAL timezone**, not UTC
- This is documented in ADR-006 lines 56-66 and is the intended behavior
- For Tokyo user: Creates Jan 8 00:00 JST → converts to "2025-01-07T15:00:00.000Z" ✓
- The timestamp correctly represents "user's Jan 8"

**The ONLY bug is in the display component** - it's extracting the UTC calendar date instead of the local calendar date from the stored timestamp.

## Hotfix Solution

### Approach: Fix Date Extraction in JournalEntryList

**Principle**: When extracting calendar date from ISO timestamp, parse as Date object and extract LOCAL date components using date-fns, not naive UTC string splitting.

### Files Modified

1. **`components/Journal/JournalEntryList.tsx`** - Line 36 only

### Implementation

**Before (broken):**
```typescript
const dateKey = entry.progressDate.split('T')[0]; // "2025-01-07" for Tokyo user ❌
```

**After (fixed):**
```typescript
// Parse ISO timestamp and extract LOCAL calendar date using date-fns
const dateKey = format(new Date(entry.progressDate), 'yyyy-MM-dd');
// For Tokyo user with "2025-01-07T15:00:00.000Z":
// - new Date() creates Date object for that moment in time
// - format() extracts date in LOCAL timezone (browser timezone)
// - In Tokyo: Jan 8 00:00 → dateKey = "2025-01-08" ✅
```

**Note**: `format` is already imported from date-fns at line 5, so no new imports needed!

### Why This Fix Works

1. **Uses date-fns consistently**: `format()` from date-fns extracts date in browser's local timezone
2. **Respects user's local calendar**: Formats the Date object using browser timezone, not UTC
3. **Clean and idiomatic**: Uses the same library already in use throughout the file
4. **Minimal change**: Single line change, leverages existing imports
5. **Consistent with existing patterns**: Similar to how Main Journal page works (but client-side instead of server-side)

### Testing

**Manual Testing Steps**:
1. Change system timezone to Asia/Tokyo (UTC+9)
2. Log progress for "today"
3. Verify Journal section on Book Detail page shows correct date
4. Verify main Journal page still works (regression check)

**Edge Cases Verified**:
- ✅ User in timezone behind UTC (e.g., Pacific Time UTC-8)
- ✅ User in timezone ahead of UTC (e.g., Tokyo UTC+9)
- ✅ Progress logged around midnight (edge of day boundary)
- ✅ Multiple progress entries on same day (group correctly)

## Impact Assessment

- **Scope**: Display-only bug, one component
- **Risk**: Very low - single line change using existing library
- **Breaking Changes**: None
- **Data Migration**: None required
- **API Changes**: None
- **Dependencies**: None (uses existing date-fns)

## Alternatives Considered (and rejected)

**Option 1: Update API to accept timezone parameter**
- Modify `/api/books/[id]/progress` to accept timezone parameter
- **Rejected**: More complex, affects multiple layers, not necessary for hotfix

**Option 2: Fix the hook to store "correct" dates**
- Change hook to store dates differently
- **Rejected**: Hook is already working correctly per ADR-006! No changes needed.

**Option 3: Use existing `formatDateOnly` helper**
- Use `/utils/dateHelpers.ts:formatDateOnly()`
- **Rejected**: That function is for formatting display, not for grouping

## Related Documentation

- **ADR-006**: [Timezone-Aware Date Handling](/docs/ADRs/ADR-006-TIMEZONE-AWARE-DATE-HANDLING.md)
- **Issue #245**: [Dates in reading progress differ between Book page and main Journal section](https://github.com/masonfox/tome/issues/245)

## Conclusion

**Problem**: Dates display one day behind for users in timezones ahead of UTC

**Root Cause**: Naive UTC date extraction via string split instead of timezone-aware parsing

**Fix**: One line change using date-fns `format()` to extract local calendar date

**Confidence**: High - Hook is working correctly per ADR-006, display bug is isolated and well-understood
